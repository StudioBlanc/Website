<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Studio Blanc — Private</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSP: allow esm.sh for the module import; keep everything else tight -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' blob: data: https:;
                 media-src 'self' blob: https:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://esm.sh;
                 connect-src 'self';
                 frame-ancestors 'none';
                 upgrade-insecure-requests">

  <style>
    :root { --bg:#F6F3EC; --fg:#222; --muted:#888; --card:#ffffff; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, Arial, sans-serif; }
    header{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; position:sticky; top:0; background:var(--bg); border-bottom:1px solid #eaeaea; z-index:10; }
    .brand{ font-weight:700; letter-spacing:.4px; }
    .role{ color: var(--muted); font-size:.9rem; }
    main{ padding:18px; max-width:1100px; margin:0 auto; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px; }
    .card{ background:var(--card); border:1px solid #eaeaea; border-radius:12px; padding:10px; position:relative; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .thumb{ width:100%; height:160px; object-fit:cover; border-radius:8px; background:#f4f4f4; }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    button, .btn{ border:1px solid #ccc; background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .btn[disabled], button[disabled]{ opacity:.5; cursor:not-allowed; }
    .muted{ color:var(--muted); }
    .hidden{ display:none !important; }
    .pill{ padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:.8rem; }
    .tag{ font-size:.85rem; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .error{ background:#ffecec; border:1px solid #ffb6b6; color:#a40000; padding:10px; border-radius:8px; margin:12px 0; }
    /* deterrents */
    *{ -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    .noctx::after { content:''; position:absolute; inset:0; background:transparent; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Studio Blanc — Private</div>
    <div class="role"><span id="roleLabel">…</span></div>
  </header>

  <main>
    <div id="err" class="error hidden"></div>

    <div class="toolbar">
      <form id="uform" class="hidden">
        <input id="files" type="file" multiple />
        <button type="submit" class="btn">Upload</button>
        <span id="status" class="muted"></span>
      </form>
      <label class="pill"><input type="checkbox" id="showTrash"> Show Trash</label>
      <button id="emptyTrash" class="btn hidden" title="Permanently purge trashed items older than 7 days">Empty Trash (older than 7d)</button>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script type="module">
    // Import the tiny client helper for direct-to-Blob uploads (token issued by our /api/private/upload)
    import { upload } from "https://esm.sh/@vercel/blob@1.1.1/client";

    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    const showTrash = document.getElementById('showTrash');
    const emptyTrashBtn = document.getElementById('emptyTrash');
    const uform = document.getElementById('uform');
    const roleLabel = document.getElementById('roleLabel');
    const errBox = document.getElementById('err');

    // Deterrents (no right-click / drag / common save shortcuts)
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && ['s','p','u','c'].includes(k)) e.preventDefault();
      if (e.key === 'F12') e.preventDefault();
    });
    document.addEventListener('dragstart', e => e.preventDefault());

    function showError(msg) {
      errBox.textContent = msg;
      errBox.classList.remove('hidden');
    }
    function clearError() {
      errBox.textContent = '';
      errBox.classList.add('hidden');
    }

    async function safeJSON(res) {
      // Helper to parse JSON or throw meaningful error
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error(`Unexpected response (${res.status}): ${text.slice(0,200)}`); }
    }

    async function getRole() {
      // Some browsers don’t pre-send Authorization on XHR/fetch the first time.
      // We fetch /api/private/me and handle 401 gracefully.
      const r = await fetch('/api/private/me', { cache: 'no-store' });
      if (r.status === 401) {
        // Ask the user to reload or open /api/private/me to trigger the browser auth.
        showError('Authentication required. Please refresh the page, or open /api/private/me in a new tab to authenticate, then come back.');
        return null;
      }
      if (!r.ok) {
        const t = await r.text().catch(()=>'');
        showError(`Could not verify your role. (${r.status}) ${t}`);
        return null;
      }
      return r.json();
    }

    function cardFor(item, isAdmin) {
      const card = document.createElement('div');
      card.className = 'card noctx';

      const label = document.createElement('div');
      label.className = 'tag';
      label.title = item.pathname;
      label.textContent = item.pathname.split('/').pop();
      card.appendChild(label);

      const src = `/api/private/view?pathname=${encodeURIComponent(item.pathname)}`;
      const ct = (item.contentType || '').toLowerCase();

      if (ct.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = item.pathname;
        img.className = 'thumb';
        img.addEventListener('dragstart', e => e.preventDefault());
        card.appendChild(img);
      } else if (ct.startsWith('video/')) {
        const vid = document.createElement('video');
        vid.src = src;
        vid.className = 'thumb';
        vid.controls = true;
        vid.controlsList = 'nodownload noremoteplayback';
        vid.disablePictureInPicture = true;
        card.appendChild(vid);
      } else {
        const a = document.createElement('a');
        a.href = src; a.target = '_blank';
        a.textContent = 'Open';
        card.appendChild(a);
      }

      const row = document.createElement('div');
      row.className = 'row';

      if (isAdmin && !item.trashed) {
        const del = document.createElement('button');
        del.textContent = 'Trash';
        del.onclick = async () => {
          if (!confirm('Move to Trash? (kept for 7 days)')) return;
          clearError();
          const r = await fetch(`/api/private/trash`, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ pathname: item.pathname })
          });
          if (!r.ok) showError(`Trash failed: ${r.status}`);
          await load();
        };
        row.appendChild(del);
      }

      if (isAdmin && item.trashed) {
        const restore = document.createElement('button');
        restore.textContent = 'Restore';
        restore.onclick = async () => {
          clearError();
          const r = await fetch(`/api/private/trash?pathname=${encodeURIComponent(item.pathname)}`, { method: 'DELETE' });
          if (!r.ok) showError(`Restore failed: ${r.status}`);
          await load();
        };
        row.appendChild(restore);
      }

      card.appendChild(row);
      return card;
    }

    async function load() {
      clearError();
      const url = '/api/private/list' + (showTrash.checked ? '?trashed=1' : '');
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const t = await r.text().catch(()=> '');
        showError(`List failed: (${r.status}) ${t}`);
        return;
      }
      const data = await safeJSON(r);
      grid.innerHTML = '';
      for (const it of (data.items || [])) grid.appendChild(cardFor(it, window.__isAdmin));
    }

    // Wire up UI
    showTrash.addEventListener('change', load);

    uform.addEventListener('submit', async (e) => {
      e.preventDefault();
      const files = document.getElementById('files').files;
      if (!files || !files.length) return;

      status.textContent = 'Uploading...';
      clearError();
      for (const file of files) {
        const pathname = `vault/${file.name}`;
        try {
          await upload(pathname, file, {
            access: 'public',          // public-but-unguessable; raw URL is never shown in UI
            addRandomSuffix: true,
            handleUploadUrl: '/api/private/upload'
          });
        } catch (err) {
          showError('Upload failed: ' + (err?.message || err));
        }
      }
      status.textContent = 'Done.';
      document.getElementById('files').value = '';
      await load();
    });

    emptyTrashBtn.addEventListener('click', async () => {
      if (!confirm('Permanently purge trashed items older than 7 days?')) return;
      clearError();
      const r = await fetch('/api/private/purge', { method: 'POST' });
      if (!r.ok) showError(`Purge failed: ${r.status}`);
      await load();
    });

    // Init
    (async () => {
      // 1) Determine role; if 401, show guidance instead of blank page
      const me = await getRole();
      if (!me) return; // error box already shown
      const isAdmin = me.role === 'admin';
      window.__isAdmin = isAdmin;

      roleLabel.textContent = isAdmin ? 'Admin' : 'Client';
      if (isAdmin) { uform.classList.remove('hidden'); emptyTrashBtn.classList.remove('hidden'); }

      // 2) Load gallery
      await load();
    })();
  </script>
</body>
</html>
