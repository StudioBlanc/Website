<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Studio Blanc — Private</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' blob: data: https:; media-src 'self' blob: https:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'strict-dynamic'; frame-ancestors 'none'; upgrade-insecure-requests">
  <meta name="referrer" content="no-referrer" />
  <style>
    :root { --bg:#F6F3EC; --fg:#222; --muted:#888; --card:#ffffff; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, Arial, sans-serif; }
    header{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; position:sticky; top:0; background:var(--bg); border-bottom:1px solid #eaeaea; z-index:10; }
    .brand{ font-weight:700; letter-spacing:.4px; }
    .role{ color: var(--muted); font-size:.9rem; }
    main{ padding:18px; max-width:1100px; margin:0 auto; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px; }
    .card{ background:var(--card); border:1px solid #eaeaea; border-radius:12px; padding:10px; position:relative; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .thumb{ width:100%; height:160px; object-fit:cover; border-radius:8px; background:#f4f4f4; }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    button, .btn { border:1px solid #ccc; background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .btn[disabled], button[disabled]{ opacity:.5; cursor:not-allowed; }
    .muted{ color:var(--muted); }
    .hidden{ display:none !important; }
    /* deterrents */
    *{ -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    .noctx::after { content:''; position:absolute; inset:0; background:transparent; }
    .pill { padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:.8rem; }
    .tag { font-size:.8rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Studio Blanc — Private</div>
    <div class="role"><span id="roleLabel">…</span></div>
  </header>
  <main>
    <div class="toolbar">
      <form id="uform" class="hidden">
        <input id="files" type="file" multiple />
        <button type="submit" class="btn">Upload</button>
        <span id="status" class="muted"></span>
      </form>
      <label class="pill"><input type="checkbox" id="showTrash"> Show Trash</label>
      <button id="emptyTrash" class="btn hidden" title="Permanently purge trashed items older than 7 days">Empty Trash (older than 7d)</button>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script type="module">
    import { upload } from "https://esm.sh/@vercel/blob@1.1.1/client";

    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    const showTrash = document.getElementById('showTrash');
    const emptyTrashBtn = document.getElementById('emptyTrash');
    const uform = document.getElementById('uform');

    // deterrents
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && ['s','p','u','c'].includes(k)) e.preventDefault();
      if (e.key === 'F12') e.preventDefault();
    });
    document.addEventListener('dragstart', e => e.preventDefault());

    const me = await fetch('/api/private/me').then(r => r.json());
    const isAdmin = me.role === 'admin';
    document.getElementById('roleLabel').textContent = isAdmin ? 'Admin' : 'Client';
    if (isAdmin) { uform.classList.remove('hidden'); emptyTrashBtn.classList.remove('hidden'); }

    function timeago(iso) {
      const t = new Date(iso);
      return t.toLocaleString();
    }

    function cardFor(item) {
      const card = document.createElement('div');
      card.className = 'card noctx';

      const src = `/api/private/view?pathname=${encodeURIComponent(item.pathname)}`;

      const label = document.createElement('div');
      label.className = 'tag';
      label.textContent = item.pathname.split('/').pop();
      card.appendChild(label);

      if ((item.contentType || '').startsWith('image/')) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = item.pathname;
        img.className = 'thumb';
        img.addEventListener('dragstart', e => e.preventDefault());
        card.appendChild(img);
      } else if ((item.contentType || '').startsWith('video/')) {
        const vid = document.createElement('video');
        vid.src = src;
        vid.className = 'thumb';
        vid.controls = true;
        vid.controlsList = 'nodownload noremoteplayback';
        vid.disablePictureInPicture = true;
        card.appendChild(vid);
      } else {
        const a = document.createElement('a');
        a.href = src; a.target = '_blank';
        a.textContent = 'Open';
        card.appendChild(a);
      }

      const row = document.createElement('div');
      row.className = 'row';

      if (isAdmin && !item.trashed) {
        const del = document.createElement('button');
        del.textContent = 'Trash';
        del.onclick = async () => {
          if (!confirm('Move to Trash? (kept for 7 days)')) return;
          await fetch(`/api/private/trash`, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ pathname: item.pathname })
          });
          await load();
        };
        row.appendChild(del);
      }

      if (isAdmin && item.trashed) {
        const restore = document.createElement('button');
        restore.textContent = 'Restore';
        restore.onclick = async () => {
          await fetch(`/api/private/trash?pathname=${encodeURIComponent(item.pathname)}`, { method: 'DELETE' });
          await load();
        };
        row.appendChild(restore);
      }

      card.appendChild(row);
      return card;
    }

    async function load() {
      const res = await fetch('/api/private/list' + (showTrash.checked ? '?trashed=1' : ''));
      const data = await res.json();
      grid.innerHTML = '';
      for (const it of (data.items || [])) grid.appendChild(cardFor(it));
    }

    showTrash.addEventListener('change', load);

    uform.addEventListener('submit', async (e) => {
      e.preventDefault();
      const files = document.getElementById('files').files;
      if (!files || !files.length) return;

      status.textContent = 'Uploading...';
      for (const file of files) {
        const pathname = `vault/${file.name}`;
        await upload(pathname, file, {
          access: 'public',
          addRandomSuffix: true,
          handleUploadUrl: '/api/private/upload'
        });
      }
      status.textContent = 'Done.';
      document.getElementById('files').value = '';
      await load();
    });

    emptyTrashBtn.addEventListener('click', async () => {
      if (!confirm('Permanently purge trashed items older than 7 days?')) return;
      await fetch('/api/private/purge', { method: 'POST' });
      await load();
    });

    await load();
  </script>
</body>
</html>
